import os
import sys
import torch
import yaml
from torchvision.datasets import CIFAR10
from src.data_utils import ComparisonDataGenerator 

project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
sys.path.insert(0, project_root)

# Load configuration
with open('config.yaml', 'r') as f:
    config = yaml.safe_load(f)

data_config = config['data_generation']
train_config = config['training']

# --- Main Script ---
print("Loading original CIFAR-10 dataset...")
cifar10_train = CIFAR10(root=data_config['cifar_path'], train=True, download=True)
generator = ComparisonDataGenerator(cifar10_train)

# Calculate m from k
k = data_config['k_candidates']
C = train_config['num_classes']
m = C - k

print(f"--- Generating datasets for comparison ---")
print(f"PL setting: k = {k} | CL setting: m = {m}")

# Generate datasets
pl_dataset = generator.generate_pl_dataset(k=k)
cl_dataset = generator.generate_cl_dataset(m=m)

# Save data
output_dir = data_config['output_dir']
os.makedirs(output_dir, exist_ok=True)
torch.save(pl_dataset, os.path.join(output_dir, f'CIFAR10_PL_k={k}.pt'))
torch.save(cl_dataset, os.path.join(output_dir, f'CIFAR10_CL_m={m}.pt'))

print(f"\nSaved generated datasets to '{output_dir}'.")
print("Done.")